# 功能规格：添加 JSON 输出格式支持

**功能分支**: `001-add-json-output`
**创建日期**: 2025-01-15
**状态**: 草稿
**输入**: 用户描述："为 ccc 添加 --json 输出格式支持，允许 validate 命令输出 JSON 格式的验证结果"

## 特别说明：使用中文

**本文档必须使用中文编写。**

1. 所有用户故事、需求描述、验收场景必须使用中文。
2. 用户场景描述应该使用自然、易懂的中文。
3. 功能需求使用中文描述，技术术语保留英文。

## 用户场景与测试 *(必填)*

### 用户故事 1 - 以 JSON 格式获取验证结果 (优先级: P1)

作为 DevOps 工程师，我希望 `ccc validate` 命令能够输出 JSON 格式的验证结果，以便在 CI/CD 流水线中程序化地解析和处理验证结果。

**为什么是这个优先级**: 这是核心功能，用户需要在自动化脚本中解析验证结果，这是最基本的使用场景。

**独立测试**: 可以通过运行 `ccc validate --json` 命令并验证输出是有效的 JSON 格式来完全测试并交付程序化解析能力。

**验收场景**:

1. **给定** ccc 配置文件正确且包含有效提供商，**当** 执行 `ccc validate --json`，**那么** 输出为 JSON 格式且包含 `{"valid": true, "provider": "..."}` 字段
2. **给定** ccc 配置文件有错误（如缺少 API key），**当** 执行 `ccc validate --json`，**那么** 输出为 JSON 格式且包含 `{"valid": false, "error": "..."}` 字段
3. **给定** 未指定 `--json` 参数，**当** 执行 `ccc validate`，**那么** 输出为人类可读的文本格式（保持向后兼容）

---

### 用户故事 2 - 验证所有提供商 (优先级: P2)

作为系统管理员，我希望 `ccc validate --json --all` 能够以 JSON 格式验证所有配置的提供商，以便一次性获取所有提供商的验证状态。

**为什么是这个优先级**: 批量验证所有提供商是有用的功能，但不是核心 MVP，可以独立于基本的单提供商 JSON 输出功能。

**独立测试**: 可以通过运行 `ccc validate --json --all` 命令并验证输出包含所有提供商的验证状态来完全测试并交付批量验证能力。

**验收场景**:

1. **给定** ccc 配置文件包含多个提供商（glm、kimi、m2），**当** 执行 `ccc validate --json --all`，**那么** 输出为 JSON 数组包含每个提供商的验证状态
2. **给定** 某些提供商配置有效、某些无效，**当** 执行 `ccc validate --json --all`，**那么** 输出正确反映每个提供商的有效/无效状态
3. **给定** 只配置了一个提供商，**当** 执行 `ccc validate --json --all`，**那么** 输出为包含单个元素的 JSON 数组

---

### 用户故事 3 - 美化 JSON 输出 (优先级: P3)

作为开发者，我希望能够选择美化（pretty-print）的 JSON 输出，以便在调试时更容易阅读。

**为什么是这个优先级**: 这是一个便利性功能，不影响核心功能，可以在基本 JSON 输出实现后再添加。

**独立测试**: 可以通过运行 `ccc validate --json --pretty` 命令并验证输出是格式化的、易读的 JSON 来完全测试并交付美化输出能力。

**验收场景**:

1. **给定** 使用 `--json` 参数但不使用 `--pretty`，**当** 执行 `ccc validate --json`，**那么** 输出为压缩的单行 JSON（默认行为）
2. **给定** 使用 `--json --pretty` 参数，**当** 执行 `ccc validate --json --pretty`，**那么** 输出为格式化的多行 JSON，包含缩进和换行

---

### 边缘情况

- 当配置文件不存在或无法解析时，JSON 输出应返回明确的错误信息
- 当配置文件为空 JSON `{}` 时，JSON 输出应反映无配置提供商的情况
- 当同时指定 `--json` 和 `--all` 但只有一个提供商时，输出格式应保持一致
- 当在非 JSON 模式下发生错误时，应保持现有的人类可读错误输出格式

## 需求 *(必填)*

### 功能需求

- **FR-001**: `ccc validate` 命令必须支持 `--json` 参数，当指定时输出 JSON 格式而非人类可读文本
- **FR-002**: JSON 输出必须包含 `valid` 布尔字段，指示验证是否通过
- **FR-003**: 当验证成功时，JSON 输出必须包含 `provider` 字段，指示被验证的提供商名称
- **FR-004**: 当验证失败时，JSON 输出必须包含 `error` 字段，包含描述性错误消息
- **FR-005**: 未指定 `--json` 参数时，`ccc validate` 必须保持现有的人类可读文本输出（向后兼容）
- **FR-006**: `ccc validate --json` 命令必须支持 `--all` 参数，输出所有提供商的验证状态
- **FR-007**: 使用 `--all` 时，JSON 输出必须是数组格式，每个元素包含单个提供商的验证结果
- **FR-008**: `ccc validate --json` 命令必须支持 `--pretty` 参数，输出格式化的 JSON（默认为压缩格式）
- **FR-009**: JSON 输出必须是有效的 JSON 格式，可以被标准 JSON 解析器解析
- **FR-010**: 当配置文件不存在或格式错误时，JSON 错误输出必须包含明确的错误描述

### 核心实体

- **验证结果 (Validation Result)**: 代表单个提供商的验证状态，包含：
  - `valid`: 布尔值，表示验证是否通过
  - `provider`: 字符串，提供商名称（如 "glm"、"kimi"）
  - `error`: 字符串（可选），错误描述信息

## 成功标准 *(必填)*

### 可衡量的结果

- **SC-001**: 开发者可以在 10 秒内解析 `ccc validate --json` 的 JSON 输出并获取验证结果
- **SC-002**: JSON 输出可以被标准的 `jq` 工具或其他 JSON 解析库正确解析
- **SC-003**: 指定 `--json` 参数后，100% 的验证场景（成功/失败/错误）都输出有效的 JSON
- **SC-004**: 不指定 `--json` 参数时，现有 CI/CD 流水线和脚本继续正常工作（完全向后兼容）

## 需求完整性检查

在继续到实现方案 (`/speckit.plan`) 之前，验证：

- [x] 没有 `[需要澄清]` 标记残留
- [x] 所有需求都可测试且无歧义
- [x] 成功标准可衡量
- [x] 每个用户故事都可独立实现和测试
- [x] 边缘情况已考虑
- [x] 与宪章原则一致（单二进制、跨平台、向后兼容）
